# PixelCanvas 設計書

## プロジェクト概要
Ultra-Light Front / Heavy-Back構成のピクセルキャンバスアプリケーション

### 技術スタック
- **フロントエンド**: Pure HTML + CSS + Vanilla JS (< 25kB)
- **バックエンド**: Supabase (PostgreSQL + Edge Functions)
- **デプロイ**: GitHub Actions

## アーキテクチャ

### フロントエンド責務（軽量化）
1. Canvasへのタイル画像描画
2. リアルタイム差分ピクセル描画
3. ユーザー入力処理
4. オフラインキュー管理

### バックエンド責務（重い処理）
1. タイル画像生成（PNG）
2. セクター拡張判定（70%ルール）
3. タイムラプス動画生成
4. リアルタイム通信管理

## データモデル

### sectors テーブル
```sql
id: int PK
x: int        -- セクターX座標
y: int        -- セクターY座標  
created_at: timestamp
```

### pixels テーブル
```sql
sector_id: int FK
x: int (0-255)    -- セクター内X座標
y: int (0-255)    -- セクター内Y座標
color: int        -- 色番号 (0-15)
user_id: uuid
updated_at: timestamp
PRIMARY KEY (sector_id, x, y)
```

### timelapse_videos テーブル
```sql
id: uuid PK
sector_id: int FK
file_path: text
created_at: timestamp
duration: int     -- 秒数
```

## UI設計

### モバイルファースト設計
- 画面サイズ: 320px〜
- タッチ操作優先
- ピンチズーム対応

### レイアウト
```
┌─────────────────────┐
│  PixelCanvas        │ <- ヘッダー (40px)
├─────────────────────┤
│                     │
│   Canvas エリア     │ <- メインキャンバス
│   (100vh - 120px)   │
│                     │
├─────────────────────┤
│ [カラーパレット]    │ <- カラー選択 (80px)
└─────────────────────┘
```

### カラーパレット（16色）
```css
#000000 #FFFFFF #FF0000 #00FF00
#0000FF #FFFF00 #FF00FF #00FFFF
#800000 #008000 #000080 #808000
#800080 #008080 #C0C0C0 #808080
```

## パフォーマンス設計

### 初期ロード最適化
1. Critical CSS インライン化
2. JS モジュール遅延読み込み
3. タイル画像の遅延読み込み

### 描画最適化
1. タイル画像はimg要素として描画（GPU活用）
2. 差分のみfillRectで描画
3. requestAnimationFrameでバッチ処理

### ネットワーク最適化
1. タイル画像キャッシュ（Service Worker）
2. WebSocket接続の再利用
3. オフラインキュー（IndexedDB）

## セキュリティ設計

### レート制限
- 描画: 1ピクセル/秒/ユーザー
- タイル取得: 10リクエスト/秒

### 認証
- 匿名ユーザーサポート（device_id）
- オプション: Supabase Auth連携

## エラーハンドリング

### フロントエンド
1. ネットワークエラー → オフラインキュー
2. 描画エラー → リトライ（最大3回）
3. WebSocket切断 → 自動再接続

### バックエンド
1. 同時書き込み → PostgreSQL競合解決
2. 容量超過 → 古いタイムラプス削除
3. 処理タイムアウト → 非同期ジョブキュー

## スケーラビリティ

### 水平拡張
- セクター単位での独立性
- CDNでのタイル画像配信
- Edge Functionの自動スケール

### データ管理
- セクターごとのテーブルパーティション
- タイムラプスの定期アーカイブ
- 統計情報の事前集計

## 今後の拡張性

### Phase 2機能候補
1. ユーザー認証・プロフィール
2. プライベートキャンバス
3. 描画履歴・取り消し機能
4. コラボレーション機能
5. NFT化機能