<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pixel Loading Test</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: monospace; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #333; }
        .pass { border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); }
        .fail { border-color: #f44336; background: rgba(244, 67, 54, 0.1); }
    </style>
</head>
<body>
    <h1>üß™ PixelCanvas Test Suite</h1>
    
    <div class="test" id="test1">
        <h3>Test 1: CONFIG Loading</h3>
        <div id="test1-result">Testing...</div>
    </div>
    
    <div class="test" id="test2">
        <h3>Test 2: Direct REST API Access</h3>
        <div id="test2-result">Testing...</div>
    </div>
    
    <div class="test" id="test3">
        <h3>Test 3: Pixel Storage</h3>
        <div id="test3-result">Testing...</div>
    </div>
    
    <div class="test" id="test4">
        <h3>Test 4: Canvas Rendering</h3>
        <div id="test4-result">Testing...</div>
    </div>
    
    <script type="module">
        import { CONFIG } from './Config.js';
        import { PixelStorage } from './PixelStorage.js';
        
        async function runTests() {
            console.log('üß™ Starting test suite...');
            
            // Test 1: CONFIG Loading
            try {
                const test1 = document.getElementById('test1');
                const test1Result = document.getElementById('test1-result');
                
                if (CONFIG && CONFIG.SUPABASE_URL && CONFIG.SUPABASE_ANON_KEY) {
                    test1Result.innerHTML = `‚úÖ PASS: CONFIG loaded<br>URL: ${CONFIG.SUPABASE_URL}<br>Key: Present`;
                    test1.className = 'test pass';
                } else {
                    throw new Error('CONFIG missing or incomplete');
                }
            } catch (error) {
                const test1 = document.getElementById('test1');
                const test1Result = document.getElementById('test1-result');
                test1Result.innerHTML = `‚ùå FAIL: ${error.message}`;
                test1.className = 'test fail';
                return; // Stop if CONFIG fails
            }
            
            // Test 2: Direct REST API Access
            try {
                const test2 = document.getElementById('test2');
                const test2Result = document.getElementById('test2-result');
                
                console.log('üß™ Testing direct REST API...');
                const testUrl = `${CONFIG.SUPABASE_URL}/rest/v1/pixels?select=count&limit=1`;
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'apikey': CONFIG.SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    test2Result.innerHTML = `‚úÖ PASS: REST API accessible<br>Status: ${response.status}<br>Data: ${JSON.stringify(data)}`;
                    test2.className = 'test pass';
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                const test2 = document.getElementById('test2');
                const test2Result = document.getElementById('test2-result');
                test2Result.innerHTML = `‚ùå FAIL: ${error.message}`;
                test2.className = 'test fail';
                return; // Stop if REST API fails
            }
            
            // Test 3: Pixel Storage
            try {
                const test3 = document.getElementById('test3');
                const test3Result = document.getElementById('test3-result');
                
                console.log('üß™ Testing pixel storage...');
                const mockPixelCanvas = { deviceId: 'test' };
                const pixelStorage = new PixelStorage(mockPixelCanvas);
                
                // Add test pixel
                pixelStorage.setPixel(0, 0, 100, 100, 5);
                
                if (pixelStorage.pixels.size === 1) {
                    const pixelKey = Array.from(pixelStorage.pixels.keys())[0];
                    const pixelColor = pixelStorage.pixels.get(pixelKey);
                    test3Result.innerHTML = `‚úÖ PASS: Pixel storage working<br>Pixels: ${pixelStorage.pixels.size}<br>Key: ${pixelKey}<br>Color: ${pixelColor}`;
                    test3.className = 'test pass';
                } else {
                    throw new Error(`Expected 1 pixel, got ${pixelStorage.pixels.size}`);
                }
            } catch (error) {
                const test3 = document.getElementById('test3');
                const test3Result = document.getElementById('test3-result');
                test3Result.innerHTML = `‚ùå FAIL: ${error.message}`;
                test3.className = 'test fail';
                return; // Stop if pixel storage fails
            }
            
            // Test 4: Canvas Rendering
            try {
                const test4 = document.getElementById('test4');
                const test4Result = document.getElementById('test4-result');
                
                console.log('üß™ Testing canvas rendering...');
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    // Test basic drawing
                    ctx.fillStyle = '#ff0000';
                    ctx.fillRect(10, 10, 50, 50);
                    
                    // Test pixel data
                    const imageData = ctx.getImageData(25, 25, 1, 1);
                    const isRed = imageData.data[0] === 255 && imageData.data[1] === 0 && imageData.data[2] === 0;
                    
                    if (isRed) {
                        test4Result.innerHTML = `‚úÖ PASS: Canvas rendering working<br>Canvas: ${canvas.width}x${canvas.height}<br>Pixel test: Red pixel detected`;
                        test4.className = 'test pass';
                        
                        // Add canvas to show
                        canvas.style.border = '1px solid white';
                        canvas.style.marginTop = '10px';
                        test4Result.appendChild(canvas);
                    } else {
                        throw new Error('Canvas pixel test failed');
                    }
                } else {
                    throw new Error('Canvas context not available');
                }
            } catch (error) {
                const test4 = document.getElementById('test4');
                const test4Result = document.getElementById('test4-result');
                test4Result.innerHTML = `‚ùå FAIL: ${error.message}`;
                test4.className = 'test fail';
                return;
            }
            
            console.log('‚úÖ All tests passed!');
        }
        
        runTests();
    </script>
</body>
</html>