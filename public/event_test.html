<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Event Handler Test</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: monospace; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #333; }
        .pass { border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); }
        .fail { border-color: #f44336; background: rgba(244, 67, 54, 0.1); }
        .canvas-container { position: relative; margin: 20px 0; border: 2px solid white; }
        canvas { display: block; background: #333; }
        .controls { margin: 10px 0; }
        button { padding: 10px; margin: 5px; background: #333; color: white; border: 1px solid #666; cursor: pointer; }
        button:hover { background: #555; }
        .event-log { max-height: 200px; overflow-y: auto; background: #222; padding: 10px; margin: 10px 0; border: 1px solid #444; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üéÆ Event Handler Test</h1>
    
    <div class="test" id="test1">
        <h3>Test 1: Mouse Events</h3>
        <div id="test1-result">Testing...</div>
    </div>
    
    <div class="test" id="test2">
        <h3>Test 2: Touch Events</h3>
        <div id="test2-result">Testing...</div>
    </div>
    
    <div class="test" id="test3">
        <h3>Test 3: Pan/Zoom Simulation</h3>
        <div id="test3-result">Testing...</div>
    </div>
    
    <div class="controls">
        <button onclick="testMousePanning()">Test Mouse Pan</button>
        <button onclick="testWheelZoom()">Test Wheel Zoom</button>
        <button onclick="simulateTouchPan()">Test Touch Pan</button>
        <button onclick="resetViewport()">Reset Viewport</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="canvas-container">
        <canvas id="testCanvas" width="400" height="300"></canvas>
    </div>
    
    <div class="event-log" id="eventLog">Event log will appear here...</div>
    
    <script type="module">
        // Mock PixelCanvas configuration
        const CONFIG = {
            PIXEL_SIZE: 4,
            GRID_SIZE: 256,
            MIN_SCALE: 0.1,
            MAX_SCALE: 16,
            TOUCH_MOVEMENT_THRESHOLD: 10,
            MOUSE_MOVEMENT_THRESHOLD: 5,
            MULTI_TOUCH_DELAY_MS: 200,
            TOUCH_RESET_DELAY_MS: 100,
            EXPANSION_DEBOUNCE_MS: 1000,
            WHEEL_DEBOUNCE_MS: 1500
        };
        
        const Utils = {
            clamp(value, min, max) {
                return Math.min(Math.max(value, min), max);
            },
            
            getTouchDistance(touch1, touch2) {
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        };
        
        // Mock PixelCanvas instance
        class MockPixelCanvas {
            constructor() {
                this.offsetX = 0;
                this.offsetY = 0;
                this.scale = 1.0;
                this.showGrid = false;
                this.isExpansionRunning = false;
                this.activeSectors = new Set(['0,0']);
                this.canvas = document.getElementById('testCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.render = this.render.bind(this);
                this.constrainViewport = this.constrainViewport.bind(this);
                this.handlePixelClick = this.handlePixelClick.bind(this);
                
                this.sectorManager = {
                    checkLoadedSectorsForExpansion: () => {
                        this.log('Sector expansion check triggered');
                    }
                };
            }
            
            render() {
                // Clear canvas
                this.ctx.fillStyle = '#333';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw viewport info
                this.ctx.fillStyle = 'white';
                this.ctx.font = '12px monospace';
                this.ctx.fillText(`Scale: ${this.scale.toFixed(3)}`, 10, 20);
                this.ctx.fillText(`Offset: (${this.offsetX.toFixed(1)}, ${this.offsetY.toFixed(1)})`, 10, 35);
                
                // Draw a test grid based on viewport
                this.ctx.strokeStyle = '#555';
                this.ctx.lineWidth = 1;
                const gridSize = 50 * this.scale;
                const startX = this.offsetX % gridSize;
                const startY = this.offsetY % gridSize;
                
                for (let x = startX; x < this.canvas.width; x += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                    this.ctx.stroke();
                }
                
                for (let y = startY; y < this.canvas.height; y += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                    this.ctx.stroke();
                }
                
                this.log(`Rendered: scale=${this.scale.toFixed(3)}, offset=(${this.offsetX.toFixed(1)}, ${this.offsetY.toFixed(1)})`);
            }
            
            constrainViewport() {
                // Simple constraints - keep some content visible
                const maxOffset = 500;
                this.offsetX = Utils.clamp(this.offsetX, -maxOffset, maxOffset);
                this.offsetY = Utils.clamp(this.offsetY, -maxOffset, maxOffset);
                this.scale = Utils.clamp(this.scale, CONFIG.MIN_SCALE, CONFIG.MAX_SCALE);
                this.log(`Viewport constrained: offset=(${this.offsetX.toFixed(1)}, ${this.offsetY.toFixed(1)}), scale=${this.scale.toFixed(3)}`);
            }
            
            handlePixelClick(x, y) {
                this.log(`Pixel click at (${x.toFixed(1)}, ${y.toFixed(1)})`);
            }
            
            log(message) {
                const eventLog = document.getElementById('eventLog');
                const timestamp = new Date().toLocaleTimeString();
                eventLog.innerHTML += `[${timestamp}] ${message}<br>`;
                eventLog.scrollTop = eventLog.scrollHeight;
            }
        }
        
        // Initialize mock PixelCanvas
        const mockPixelCanvas = new MockPixelCanvas();
        window.mockPixelCanvas = mockPixelCanvas;
        
        // Import and initialize EventHandlers
        import('./EventHandlers.js').then(module => {
            const { EventHandlers } = module;
            
            // Mock the required imports for EventHandlers
            window.CONFIG = CONFIG;
            window.Utils = Utils;
            
            try {
                const eventHandlers = new EventHandlers(mockPixelCanvas.canvas, mockPixelCanvas);
                window.eventHandlers = eventHandlers;
                
                setTestStatus('test1', 'pass', '‚úÖ PASS: Mouse event handlers initialized');
                setTestStatus('test2', 'pass', '‚úÖ PASS: Touch event handlers initialized');
                
                mockPixelCanvas.log('Event handlers initialized successfully');
                mockPixelCanvas.render();
                
                // Test basic functionality
                setTimeout(testEventHandlers, 100);
                
            } catch (error) {
                setTestStatus('test1', 'fail', `‚ùå FAIL: ${error.message}`);
                setTestStatus('test2', 'fail', `‚ùå FAIL: ${error.message}`);
                mockPixelCanvas.log(`Error: ${error.message}`);
            }
        }).catch(error => {
            setTestStatus('test1', 'fail', `‚ùå FAIL: Could not load EventHandlers: ${error.message}`);
            setTestStatus('test2', 'fail', `‚ùå FAIL: Could not load EventHandlers: ${error.message}`);
            mockPixelCanvas.log(`Import error: ${error.message}`);
        });
        
        function setTestStatus(testId, status, message) {
            const test = document.getElementById(testId);
            const result = document.getElementById(testId + '-result');
            test.className = 'test ' + status;
            result.innerHTML = message;
        }
        
        function testEventHandlers() {
            // Test pan/zoom simulation
            const originalOffsetX = mockPixelCanvas.offsetX;
            const originalOffsetY = mockPixelCanvas.offsetY;
            const originalScale = mockPixelCanvas.scale;
            
            try {
                // Simulate pan
                mockPixelCanvas.offsetX += 50;
                mockPixelCanvas.offsetY += 30;
                mockPixelCanvas.constrainViewport();
                
                // Simulate zoom
                mockPixelCanvas.scale = 1.5;
                mockPixelCanvas.constrainViewport();
                
                mockPixelCanvas.render();
                
                if (mockPixelCanvas.offsetX !== originalOffsetX || 
                    mockPixelCanvas.offsetY !== originalOffsetY ||
                    mockPixelCanvas.scale !== originalScale) {
                    setTestStatus('test3', 'pass', '‚úÖ PASS: Pan/zoom simulation working<br>Viewport changes applied successfully');
                } else {
                    setTestStatus('test3', 'fail', '‚ùå FAIL: Viewport did not change');
                }
            } catch (error) {
                setTestStatus('test3', 'fail', `‚ùå FAIL: ${error.message}`);
            }
        }
        
        // Manual test functions
        window.testMousePanning = function() {
            mockPixelCanvas.offsetX += 20;
            mockPixelCanvas.offsetY += 15;
            mockPixelCanvas.constrainViewport();
            mockPixelCanvas.render();
        };
        
        window.testWheelZoom = function() {
            mockPixelCanvas.scale *= 1.2;
            mockPixelCanvas.constrainViewport();
            mockPixelCanvas.render();
        };
        
        window.simulateTouchPan = function() {
            mockPixelCanvas.offsetX -= 30;
            mockPixelCanvas.offsetY -= 20;
            mockPixelCanvas.constrainViewport();
            mockPixelCanvas.render();
        };
        
        window.resetViewport = function() {
            mockPixelCanvas.offsetX = 0;
            mockPixelCanvas.offsetY = 0;
            mockPixelCanvas.scale = 1.0;
            mockPixelCanvas.render();
            mockPixelCanvas.log('Viewport reset to default');
        };
        
        window.clearLog = function() {
            document.getElementById('eventLog').innerHTML = '';
        };
    </script>
</body>
</html>