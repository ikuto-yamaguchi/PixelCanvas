<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pixel Loading Fix Test</title>
    <style>
        body { 
            background: #1a1a1a; 
            color: white; 
            font-family: monospace; 
            padding: 20px; 
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); }
        .error { border-color: #f44336; background: rgba(244, 67, 54, 0.1); }
        .progress { border-color: #2196F3; background: rgba(33, 150, 243, 0.1); }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #console {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ PixelCanvas ä¿®æ­£ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section progress" id="status">
        <h3>ğŸš€ åˆæœŸåŒ–ä¸­...</h3>
        <p>ä¾å­˜é–¢ä¿‚ã®èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...</p>
    </div>
    
    <div style="margin: 20px 0;">
        <button onclick="testNetworkManagerLoading()">ğŸ§ª NetworkManagerèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testRenderingSystem()">ğŸ¨ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="clearConsole()">ğŸ§¹ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¯ãƒªã‚¢</button>
    </div>
    
    <div class="test-section">
        <h4>ğŸ“„ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›:</h4>
        <div id="console"></div>
    </div>
    
    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="module">
        import { CONFIG } from './Config.js';
        import { NetworkManager } from './NetworkManager.js';
        import { PixelStorage } from './PixelStorage.js';
        
        // Console capture
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsole(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${type}: ${args.join(' ')}\n`;
            consoleDiv.textContent += line;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = (...args) => {
            originalLog.apply(console, args);
            addToConsole('LOG', ...args);
        };
        
        console.error = (...args) => {
            originalError.apply(console, args);
            addToConsole('ERROR', ...args);
        };
        
        console.warn = (...args) => {
            originalWarn.apply(console, args);
            addToConsole('WARN', ...args);
        };
        
        let mockPixelCanvas = null;
        let networkManager = null;
        
        window.clearConsole = function() {
            consoleDiv.textContent = '';
        };
        
        // Initialize test environment
        async function initializeTest() {
            const status = document.getElementById('status');
            
            try {
                status.innerHTML = '<h3>ğŸ”§ ãƒ†ã‚¹ãƒˆç’°å¢ƒåˆæœŸåŒ–ä¸­...</h3>';
                
                // Wait for Supabase
                let retries = 0;
                while (!window.supabase && retries < 10) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    retries++;
                }
                
                if (!window.supabase) {
                    throw new Error('Supabase failed to load');
                }
                
                console.log('âœ… Supabase loaded successfully');
                
                // Create mock PixelCanvas
                mockPixelCanvas = {
                    pixelStorage: new PixelStorage({ deviceId: 'test-fix' }),
                    activeSectors: new Set(['0,0']),
                    sectorPixelCounts: new Map(),
                    debugPanel: { log: console.log },
                    deviceId: 'test-fix-device',
                    render: () => console.log('ğŸ¨ Mock render called'),
                    updateStockDisplay: () => console.log('ğŸ“Š Mock updateStockDisplay called')
                };
                
                console.log('ğŸ”§ Mock PixelCanvas created');
                
                // Create NetworkManager
                networkManager = new NetworkManager(mockPixelCanvas);
                console.log('ğŸ”§ NetworkManager created');
                
                // Wait for initialization
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                status.innerHTML = '<h3>âœ… ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™å®Œäº†</h3><p>ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„</p>';
                status.className = 'test-section success';
                
            } catch (error) {
                console.error('âŒ Test initialization failed:', error);
                status.innerHTML = `<h3>âŒ åˆæœŸåŒ–å¤±æ•—</h3><p>${error.message}</p>`;
                status.className = 'test-section error';
            }
        }
        
        window.testNetworkManagerLoading = async function() {
            const status = document.getElementById('status');
            
            if (!networkManager) {
                status.innerHTML = '<h3>âŒ NetworkManagerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>';
                status.className = 'test-section error';
                return;
            }
            
            try {
                status.innerHTML = '<h3>ğŸ”„ NetworkManagerèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</h3>';
                status.className = 'test-section progress';
                
                console.log('ğŸš€ Starting NetworkManager pixel loading test...');
                console.log('ğŸ”§ Initial pixel count:', mockPixelCanvas.pixelStorage.pixels.size);
                
                // Test the fixed loadPixelsFromSupabase method
                await networkManager.loadPixelsFromSupabase();
                
                const finalCount = mockPixelCanvas.pixelStorage.pixels.size;
                console.log('ğŸ“Š Final pixel count:', finalCount);
                
                if (finalCount > 0) {
                    status.innerHTML = `<h3>âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ!</h3><p>èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ”ã‚¯ã‚»ãƒ«æ•°: ${finalCount}</p>`;
                    status.className = 'test-section success';
                    
                    // Show sample pixels
                    const samplePixels = Array.from(mockPixelCanvas.pixelStorage.pixels.entries()).slice(0, 5);
                    console.log('ğŸ“‹ Sample pixels:', samplePixels);
                } else {
                    throw new Error('No pixels were loaded');
                }
                
            } catch (error) {
                console.error('âŒ NetworkManager test failed:', error);
                status.innerHTML = `<h3>âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—</h3><p>${error.message}</p>`;
                status.className = 'test-section error';
            }
        };
        
        window.testRenderingSystem = async function() {
            const status = document.getElementById('status');
            
            if (!mockPixelCanvas || mockPixelCanvas.pixelStorage.pixels.size === 0) {
                status.innerHTML = '<h3>âš ï¸ ã¾ãšãƒ”ã‚¯ã‚»ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</h3>';
                status.className = 'test-section error';
                return;
            }
            
            try {
                status.innerHTML = '<h3>ğŸ”„ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</h3>';
                status.className = 'test-section progress';
                
                console.log('ğŸ¨ Testing rendering system...');
                
                // Create test canvas
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 300;
                canvas.style.border = '1px solid white';
                canvas.style.margin = '10px 0';
                
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Render some pixels from storage
                let rendered = 0;
                for (const [key, color] of mockPixelCanvas.pixelStorage.pixels) {
                    if (rendered >= 20) break; // Limit to 20 pixels for test
                    
                    const [sectorX, sectorY, localX, localY] = key.split(',').map(Number);
                    const worldX = sectorX * CONFIG.GRID_SIZE + localX;
                    const worldY = sectorY * CONFIG.GRID_SIZE + localY;
                    
                    // Simple rendering (just place pixels in a grid for testing)
                    const testX = 50 + (rendered % 10) * 30;
                    const testY = 50 + Math.floor(rendered / 10) * 30;
                    
                    ctx.fillStyle = CONFIG.PALETTE[color] || '#ffffff';
                    ctx.fillRect(testX, testY, 20, 20);
                    
                    rendered++;
                }
                
                console.log(`ğŸ¨ Rendered ${rendered} test pixels`);
                
                // Add canvas to page
                const testDiv = document.createElement('div');
                testDiv.innerHTML = '<h4>ğŸ–¼ï¸ ãƒ†ã‚¹ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœ:</h4>';
                testDiv.appendChild(canvas);
                
                // Remove any existing test canvas
                const existing = document.querySelector('#test-canvas-container');
                if (existing) existing.remove();
                
                testDiv.id = 'test-canvas-container';
                document.body.appendChild(testDiv);
                
                status.innerHTML = `<h3>âœ… ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆæˆåŠŸ!</h3><p>æç”»ã•ã‚ŒãŸãƒ”ã‚¯ã‚»ãƒ«æ•°: ${rendered}</p>`;
                status.className = 'test-section success';
                
            } catch (error) {
                console.error('âŒ Rendering test failed:', error);
                status.innerHTML = `<h3>âŒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—</h3><p>${error.message}</p>`;
                status.className = 'test-section error';
            }
        };
        
        // Auto-initialize
        window.addEventListener('load', () => {
            setTimeout(initializeTest, 1000);
        });
        
        console.log('ğŸ§ª Test fix page loaded');
    </script>
</body>
</html>