<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="PixelCanvas - å…±åŒãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ">
    <title>PixelCanvas - å…±åŒãƒ”ã‚¯ã‚»ãƒ«ã‚¢ãƒ¼ãƒˆ</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.webmanifest">
    
    <link rel="preconnect" href="https://lgvjdefkyeuvquzckkvb.supabase.co">
    <link rel="dns-prefetch" href="https://lgvjdefkyeuvquzckkvb.supabase.co">
</head>
<body>
    <header class="header">
        <h1 class="header__title">PixelCanvas</h1>
        <div class="header__controls">
            <button class="grid-toggle" id="gridToggle" aria-label="Toggle Grid">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M2 2h6v6H2V2zm10 0h6v6h-6V2zM2 12h6v6H2v-6zm10 0h6v6h-6v-6z" stroke="currentColor" stroke-width="1"/>
                </svg>
            </button>
            <div class="pixel-count" id="pixelCount">0px</div>
            <div class="cooldown-indicator" id="cooldownIndicator"></div>
            <span class="status-indicator" id="status"></span>
        </div>
    </header>

    <main class="main">
        <div class="canvas-container" id="canvasContainer">
            <canvas id="mainCanvas" class="canvas"></canvas>
            <div class="canvas-overlay" id="canvasOverlay"></div>
        </div>
    </main>

    <footer class="controls">
        <div class="color-palette" id="colorPalette">
            <button class="color-button" data-color="0" style="background-color: #000000" aria-label="Black"></button>
            <button class="color-button" data-color="1" style="background-color: #FFFFFF" aria-label="White"></button>
            <button class="color-button" data-color="2" style="background-color: #FF0000" aria-label="Red"></button>
            <button class="color-button" data-color="3" style="background-color: #00FF00" aria-label="Green"></button>
            <button class="color-button" data-color="4" style="background-color: #0000FF" aria-label="Blue"></button>
            <button class="color-button" data-color="5" style="background-color: #FFFF00" aria-label="Yellow"></button>
            <button class="color-button" data-color="6" style="background-color: #FF00FF" aria-label="Magenta"></button>
            <button class="color-button" data-color="7" style="background-color: #00FFFF" aria-label="Cyan"></button>
            <button class="color-button" data-color="8" style="background-color: #800000" aria-label="Dark Red"></button>
            <button class="color-button" data-color="9" style="background-color: #008000" aria-label="Dark Green"></button>
            <button class="color-button" data-color="10" style="background-color: #000080" aria-label="Dark Blue"></button>
            <button class="color-button" data-color="11" style="background-color: #808000" aria-label="Olive"></button>
            <button class="color-button" data-color="12" style="background-color: #800080" aria-label="Purple"></button>
            <button class="color-button" data-color="13" style="background-color: #008080" aria-label="Teal"></button>
            <button class="color-button" data-color="14" style="background-color: #C0C0C0" aria-label="Silver"></button>
            <button class="color-button" data-color="15" style="background-color: #808080" aria-label="Gray"></button>
        </div>
    </footer>

    <!-- vConsole for mobile debugging -->
    <script src="vconsole.min.js"></script>
    <script>
        // Initialize vConsole for debugging
        try {
            const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Enable for mobile OR when URL contains debug=vconsole
            const forceVConsole = new URLSearchParams(window.location.search).get('debug') === 'vconsole';
            
            if (isMobile || forceVConsole) {
                const vConsole = new VConsole({
                    theme: 'dark',
                    defaultPlugins: ['system', 'network', 'element', 'storage'],
                    maxLogNumber: 2000,
                    onReady: function() {
                        console.log('ğŸ“± vConsole ready for debugging!');
                        console.warn('âš ï¸ Warning test message');
                        console.error('âŒ Error test message');
                        
                        // ãƒ­ã‚°ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½è¿½åŠ 
                        setTimeout(() => {
                            addLogCopyFeature();
                        }, 500);
                    }
                });
                
                console.log(`ğŸ“± vConsole initialized - Mobile: ${isMobile}, Forced: ${forceVConsole}`);
                
                // Store reference globally for testing
                window.vConsole = vConsole;
            } else {
                console.log('ğŸ’» Desktop mode - vConsole disabled (add ?debug=vconsole to URL to force enable)');
            }
        } catch (error) {
            console.error('âŒ Failed to initialize vConsole:', error);
        }
        
        // ãƒ­ã‚°ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã®è¿½åŠ 
        function addLogCopyFeature() {
            try {
                // vConsoleã®DOMæ§‹é€ ã‚’è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æ¤œç´¢
                let consoleTab = null;
                let retryCount = 0;
                const maxRetries = 10;
                
                // è¤‡æ•°ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™
                const selectors = [
                    '#__vconsole .vc-tab[data-tab="default"]',
                    '#__vconsole .vc-tab[data-tab="console"]', 
                    '#__vconsole [data-tab="default"]',
                    '#__vconsole [data-tab="console"]',
                    '#__vconsole .vc-tabbar',
                    '#__vconsole .vc-switch',
                    '#__vconsole'
                ];
                
                for (const selector of selectors) {
                    consoleTab = document.querySelector(selector);
                    if (consoleTab) {
                        console.log(`âœ… Found vConsole element with selector: ${selector}`);
                        break;
                    }
                }
                
                if (!consoleTab) {
                    // DOMæ§‹é€ ã‚’ãƒ­ã‚°å‡ºåŠ›ã—ã¦ãƒ‡ãƒãƒƒã‚°
                    const vconsoleElement = document.querySelector('#__vconsole');
                    if (vconsoleElement) {
                        console.log('ğŸ” vConsole DOM structure:', vconsoleElement.innerHTML.substring(0, 500));
                        const allTabs = vconsoleElement.querySelectorAll('[class*="tab"], [data-tab]');
                        console.log('ğŸ” Available tabs:', Array.from(allTabs).map(tab => ({
                            className: tab.className,
                            dataset: tab.dataset,
                            tagName: tab.tagName
                        })));
                    }
                    
                    retryCount++;
                    if (retryCount < maxRetries) {
                        console.warn(`vConsole element not found, retrying... (${retryCount}/${maxRetries})`);
                        setTimeout(addLogCopyFeature, 1000);
                        return;
                    } else {
                        console.error('âŒ Failed to find vConsole after max retries');
                        // æœ€å¾Œã®æ‰‹æ®µ: vConsoleå…¨ä½“ã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                        addFloatingCopyButton();
                        return;
                    }
                }
                
                // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’vConsoleå†…ã«è¿½åŠ 
                if (!document.querySelector('.vc-copy-logs-btn')) {
                    const copyButton = document.createElement('button');
                    copyButton.className = 'vc-copy-logs-btn';
                    copyButton.innerHTML = 'ğŸ“‹ Copy All Logs';
                    copyButton.style.cssText = `
                        position: fixed;
                        top: 60px;
                        right: 15px;
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        cursor: pointer;
                        z-index: 99999;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    `;
                    
                    copyButton.addEventListener('click', () => {
                        copyAllLogs();
                    });
                    
                    // vConsoleè¦ç´ ã¾ãŸã¯bodyã«è¿½åŠ 
                    const vconsoleRoot = document.querySelector('#__vconsole') || document.body;
                    vconsoleRoot.appendChild(copyButton);
                    console.log('âœ… Log copy button added to vConsole');
                }
                
                // å„ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã«ã‚‚ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
                function addCopyButtonsToLogs() {
                    const logList = document.querySelector('#__vconsole .vc-log-list');
                    if (logList) {
                        // ãƒ­ã‚°ãƒªã‚¹ãƒˆã®å¤‰æ›´ã‚’ç›£è¦–
                        const observer = new MutationObserver(() => {
                            const logItems = logList.querySelectorAll('.vc-item:not(.vc-copy-added)');
                            logItems.forEach(item => {
                                if (!item.querySelector('.vc-copy-single-btn')) {
                                    const copyBtn = document.createElement('span');
                                    copyBtn.className = 'vc-copy-single-btn';
                                    copyBtn.innerHTML = 'ğŸ“‹';
                                    copyBtn.style.cssText = `
                                        display: inline-block;
                                        margin-left: 8px;
                                        cursor: pointer;
                                        opacity: 0.6;
                                        font-size: 12px;
                                    `;
                                    copyBtn.title = 'Copy this log';
                                    
                                    copyBtn.addEventListener('click', (e) => {
                                        e.stopPropagation();
                                        const logContent = item.textContent.replace('ğŸ“‹', '').trim();
                                        copyToClipboard(logContent);
                                        showCopyFeedback(copyBtn);
                                    });
                                    
                                    const logContent = item.querySelector('.vc-item-content');
                                    if (logContent) {
                                        logContent.appendChild(copyBtn);
                                    }
                                    item.classList.add('vc-copy-added');
                                }
                            });
                        });
                        observer.observe(logList, { childList: true, subtree: true });
                    }
                }
                
                // å°‘ã—é…å»¶ã—ã¦ãƒ­ã‚°ãƒœã‚¿ãƒ³ã‚‚è¿½åŠ 
                setTimeout(addCopyButtonsToLogs, 500);
                
            } catch (error) {
                console.error('âŒ Failed to add log copy feature:', error);
            }
        }
        
        // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        function addFloatingCopyButton() {
            if (document.querySelector('.vc-floating-copy-btn')) return;
            
            const floatingButton = document.createElement('button');
            floatingButton.className = 'vc-floating-copy-btn';
            floatingButton.innerHTML = 'ğŸ“‹';
            floatingButton.title = 'Copy all vConsole logs';
            floatingButton.style.cssText = `
                position: fixed;
                bottom: 80px;
                right: 20px;
                width: 50px;
                height: 50px;
                background: #4CAF50;
                color: white;
                border: none;
                border-radius: 50%;
                font-size: 20px;
                cursor: pointer;
                z-index: 99999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            floatingButton.addEventListener('click', () => {
                copyAllLogs();
            });
            
            document.body.appendChild(floatingButton);
            console.log('âœ… Floating copy button added as fallback');
        }
        
        // å…¨ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
        function copyAllLogs() {
            try {
                // è¤‡æ•°ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã§ãƒ­ã‚°ãƒªã‚¹ãƒˆã‚’æ¤œç´¢
                let logList = null;
                let logItems = [];
                
                const logSelectors = [
                    '#__vconsole .vc-log-list',
                    '#__vconsole .vc-content',
                    '#__vconsole [class*="log"]',
                    '#__vconsole .vc-panel',
                    '#__vconsole .vc-tabpanel'
                ];
                
                for (const selector of logSelectors) {
                    logList = document.querySelector(selector);
                    if (logList) {
                        // ãƒ­ã‚°ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢
                        const itemSelectors = ['.vc-item', '.vc-log-item', '[class*="item"]', 'div', 'p'];
                        for (const itemSelector of itemSelectors) {
                            logItems = logList.querySelectorAll(itemSelector);
                            if (logItems.length > 0) {
                                console.log(`âœ… Found ${logItems.length} log items with selector: ${selector} > ${itemSelector}`);
                                break;
                            }
                        }
                        if (logItems.length > 0) break;
                    }
                }
                
                if (!logList || logItems.length === 0) {
                    // vConsoleå…¨ä½“ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
                    const vconsoleElement = document.querySelector('#__vconsole');
                    if (vconsoleElement) {
                        const allText = vconsoleElement.innerText || vconsoleElement.textContent;
                        if (allText) {
                            copyToClipboard(`=== PixelCanvas vConsole Content ===\n${allText}`);
                            alert('âœ… vConsoleã®å…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                            return;
                        }
                    }
                    alert('âŒ ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                let allLogs = [];
                
                logItems.forEach((item, index) => {
                    // ãƒ­ã‚°ã‚¿ã‚¤ãƒ—ã‚’è¤‡æ•°ã®æ–¹æ³•ã§åˆ¤å®š
                    let logType = 'LOG';
                    const className = item.className || '';
                    const itemText = item.textContent || item.innerText || '';
                    
                    if (className.includes('error') || className.includes('vc-item-error') || 
                        itemText.includes('âŒ') || itemText.includes('ERROR')) {
                        logType = 'ERROR';
                    } else if (className.includes('warn') || className.includes('vc-item-warn') || 
                              itemText.includes('âš ï¸') || itemText.includes('WARN')) {
                        logType = 'WARN';
                    } else if (className.includes('info') || className.includes('vc-item-info') || 
                              itemText.includes('â„¹ï¸') || itemText.includes('INFO')) {
                        logType = 'INFO';
                    }
                    
                    // ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‚’è¤‡æ•°ã®æ–¹æ³•ã§æŠ½å‡º
                    let content = '';
                    
                    // 1. textContentã‹ã‚‰å–å¾—
                    if (item.textContent) {
                        content = item.textContent.replace('ğŸ“‹', '').trim();
                    }
                    
                    // 2. ç©ºã®å ´åˆã¯å­è¦ç´ ã‚’æ¢ã™
                    if (!content || content.length < 3) {
                        const contentElement = item.querySelector('.vc-item-content, .vc-content, .log-content');
                        if (contentElement) {
                            content = contentElement.textContent || contentElement.innerText || '';
                        }
                    }
                    
                    // 3. ã¾ã ç©ºã®å ´åˆã¯å…¨ã¦ã®å­è¦ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
                    if (!content || content.length < 3) {
                        const allTextNodes = [];
                        const walker = document.createTreeWalker(
                            item,
                            NodeFilter.SHOW_TEXT,
                            null,
                            false
                        );
                        
                        let node;
                        while (node = walker.nextNode()) {
                            const text = node.textContent.trim();
                            if (text && text !== 'ğŸ“‹') {
                                allTextNodes.push(text);
                            }
                        }
                        content = allTextNodes.join(' ');
                    }
                    
                    // 4. æœ€å¾Œã®æ‰‹æ®µ: innerHTML ã‹ã‚‰æŠ½å‡º
                    if (!content || content.length < 3) {
                        content = item.innerHTML.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    }
                    
                    // ç©ºã®å ´åˆã¯DOMæƒ…å ±ã‚’å«ã‚ã‚‹
                    if (!content || content.length < 3) {
                        content = `[Empty log item - className: ${className}, tagName: ${item.tagName}]`;
                    }
                    
                    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ½å‡ºè©¦è¡Œ
                    const timeElement = item.querySelector('.vc-item-time, .timestamp, [class*="time"]');
                    const timestamp = timeElement ? timeElement.textContent : new Date().toLocaleTimeString();
                    
                    allLogs.push(`[${index + 1}] [${timestamp}] [${logType}] ${content}`);
                });
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚‚å«ã‚ã‚‹
                const debugInfo = [
                    `Debug Info:`,
                    `- Log List Selector: ${logSelectors.find(s => document.querySelector(s)) || 'Not found'}`,
                    `- Log Items Found: ${logItems.length}`,
                    `- Sample Item HTML: ${logItems[0] ? logItems[0].outerHTML.substring(0, 200) + '...' : 'None'}`,
                    `- vConsole DOM: ${document.querySelector('#__vconsole') ? 'Found' : 'Not found'}`,
                    ''
                ];
                
                const logText = [
                    '=== PixelCanvas vConsole Logs ===',
                    `Exported: ${new Date().toLocaleString()}`,
                    `Total Logs: ${allLogs.length}`,
                    '=' .repeat(40),
                    '',
                    ...debugInfo,
                    ...allLogs,
                    '',
                    '=== End of Logs ==='
                ].join('\n');
                
                copyToClipboard(logText);
                
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
                const button = document.querySelector('.vc-copy-logs-btn');
                if (button) {
                    const originalText = button.innerHTML;
                    button.innerHTML = 'âœ… Copied!';
                    button.style.background = '#2196F3';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.background = '#4CAF50';
                    }, 1500);
                }
                
                console.log(`ğŸ“‹ ${allLogs.length} logs copied to clipboard`);
                
            } catch (error) {
                console.error('âŒ Failed to copy logs:', error);
                alert('âŒ ãƒ­ã‚°ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                // ç¾ä»£çš„ãªãƒ–ãƒ©ã‚¦ã‚¶
                navigator.clipboard.writeText(text).catch(err => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                fallbackCopyTextToClipboard(text);
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                console.log('ğŸ“‹ Copied using fallback method');
            } catch (err) {
                console.error('âŒ Fallback copy failed:', err);
            }
            
            document.body.removeChild(textArea);
        }
        
        // ã‚³ãƒ”ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
        function showCopyFeedback(element) {
            const original = element.innerHTML;
            element.innerHTML = 'âœ…';
            element.style.color = '#4CAF50';
            setTimeout(() => {
                element.innerHTML = original;
                element.style.color = '';
            }, 1000);
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
        window.copyAllVConsoleLogs = copyAllLogs;
        
    </script>
    
    <script src="idb.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="main.js" defer></script>
</body>
</html>