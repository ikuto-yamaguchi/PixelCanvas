<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="PixelCanvas - ÂÖ±Âêå„Éî„ÇØ„Çª„É´„Ç¢„Éº„Éà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†">
    <title>PixelCanvas - ÂÖ±Âêå„Éî„ÇØ„Çª„É´„Ç¢„Éº„Éà</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.webmanifest">
    
    <link rel="preconnect" href="https://lgvjdefkyeuvquzckkvb.supabase.co">
    <link rel="dns-prefetch" href="https://lgvjdefkyeuvquzckkvb.supabase.co">
</head>
<body>
    <header class="header">
        <h1 class="header__title">PixelCanvas</h1>
        <div class="header__controls">
            <button class="grid-toggle" id="gridToggle" aria-label="Toggle Grid">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M2 2h6v6H2V2zm10 0h6v6h-6V2zM2 12h6v6H2v-6zm10 0h6v6h-6v-6z" stroke="currentColor" stroke-width="1"/>
                </svg>
            </button>
            <div class="pixel-count" id="pixelCount">0px</div>
            <div class="cooldown-indicator" id="cooldownIndicator"></div>
            <span class="status-indicator" id="status"></span>
        </div>
    </header>

    <main class="main">
        <div class="canvas-container" id="canvasContainer">
            <canvas id="mainCanvas" class="canvas"></canvas>
            <div class="canvas-overlay" id="canvasOverlay"></div>
        </div>
    </main>

    <footer class="controls">
        <div class="color-palette" id="colorPalette">
            <button class="color-button" data-color="0" style="background-color: #000000" aria-label="Black"></button>
            <button class="color-button" data-color="1" style="background-color: #FFFFFF" aria-label="White"></button>
            <button class="color-button" data-color="2" style="background-color: #FF0000" aria-label="Red"></button>
            <button class="color-button" data-color="3" style="background-color: #00FF00" aria-label="Green"></button>
            <button class="color-button" data-color="4" style="background-color: #0000FF" aria-label="Blue"></button>
            <button class="color-button" data-color="5" style="background-color: #FFFF00" aria-label="Yellow"></button>
            <button class="color-button" data-color="6" style="background-color: #FF00FF" aria-label="Magenta"></button>
            <button class="color-button" data-color="7" style="background-color: #00FFFF" aria-label="Cyan"></button>
            <button class="color-button" data-color="8" style="background-color: #800000" aria-label="Dark Red"></button>
            <button class="color-button" data-color="9" style="background-color: #008000" aria-label="Dark Green"></button>
            <button class="color-button" data-color="10" style="background-color: #000080" aria-label="Dark Blue"></button>
            <button class="color-button" data-color="11" style="background-color: #808000" aria-label="Olive"></button>
            <button class="color-button" data-color="12" style="background-color: #800080" aria-label="Purple"></button>
            <button class="color-button" data-color="13" style="background-color: #008080" aria-label="Teal"></button>
            <button class="color-button" data-color="14" style="background-color: #C0C0C0" aria-label="Silver"></button>
            <button class="color-button" data-color="15" style="background-color: #808080" aria-label="Gray"></button>
        </div>
    </footer>

    <!-- vConsole for mobile debugging -->
    <script src="vconsole.min.js"></script>
    <script>
        // Initialize vConsole for debugging
        try {
            const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Enable for mobile OR when URL contains debug=vconsole
            const forceVConsole = new URLSearchParams(window.location.search).get('debug') === 'vconsole';
            
            if (isMobile || forceVConsole) {
                const vConsole = new VConsole({
                    theme: 'dark',
                    defaultPlugins: ['system', 'network', 'element', 'storage'],
                    maxLogNumber: 2000,
                    onReady: function() {
                        console.log('üì± vConsole ready for debugging!');
                        console.warn('‚ö†Ô∏è Warning test message');
                        console.error('‚ùå Error test message');
                        
                        // „É≠„Ç∞„Ç≥„Éî„ÉºÊ©üËÉΩËøΩÂä†
                        setTimeout(() => {
                            addLogCopyFeature();
                        }, 500);
                    }
                });
                
                console.log(`üì± vConsole initialized - Mobile: ${isMobile}, Forced: ${forceVConsole}`);
                
                // Store reference globally for testing
                window.vConsole = vConsole;
            } else {
                console.log('üíª Desktop mode - vConsole disabled (add ?debug=vconsole to URL to force enable)');
            }
        } catch (error) {
            console.error('‚ùå Failed to initialize vConsole:', error);
        }
        
        // „É≠„Ç∞„Ç≥„Éî„ÉºÊ©üËÉΩ„ÅÆËøΩÂä†
        function addLogCopyFeature() {
            try {
                // vConsole„ÅÆDOMÊßãÈÄ†„ÇíË§áÊï∞„Éë„Çø„Éº„É≥„ÅßÊ§úÁ¥¢
                let consoleTab = null;
                let retryCount = 0;
                const maxRetries = 10;
                
                // Ë§áÊï∞„ÅÆ„Çª„É¨„ÇØ„Çø„Éº„Éë„Çø„Éº„É≥„ÇíË©¶„Åô
                const selectors = [
                    '#__vconsole .vc-tab[data-tab="default"]',
                    '#__vconsole .vc-tab[data-tab="console"]', 
                    '#__vconsole [data-tab="default"]',
                    '#__vconsole [data-tab="console"]',
                    '#__vconsole .vc-tabbar',
                    '#__vconsole .vc-switch',
                    '#__vconsole'
                ];
                
                for (const selector of selectors) {
                    consoleTab = document.querySelector(selector);
                    if (consoleTab) {
                        console.log(`‚úÖ Found vConsole element with selector: ${selector}`);
                        break;
                    }
                }
                
                if (!consoleTab) {
                    // DOMÊßãÈÄ†„Çí„É≠„Ç∞Âá∫Âäõ„Åó„Å¶„Éá„Éê„ÉÉ„Ç∞
                    const vconsoleElement = document.querySelector('#__vconsole');
                    if (vconsoleElement) {
                        console.log('üîç vConsole DOM structure:', vconsoleElement.innerHTML.substring(0, 500));
                        const allTabs = vconsoleElement.querySelectorAll('[class*="tab"], [data-tab]');
                        console.log('üîç Available tabs:', Array.from(allTabs).map(tab => ({
                            className: tab.className,
                            dataset: tab.dataset,
                            tagName: tab.tagName
                        })));
                    }
                    
                    retryCount++;
                    if (retryCount < maxRetries) {
                        console.warn(`vConsole element not found, retrying... (${retryCount}/${maxRetries})`);
                        setTimeout(addLogCopyFeature, 1000);
                        return;
                    } else {
                        console.error('‚ùå Failed to find vConsole after max retries');
                        // ÊúÄÂæå„ÅÆÊâãÊÆµ: vConsoleÂÖ®‰Ωì„Å´„Éú„Çø„É≥„ÇíËøΩÂä†
                        addFloatingCopyButton();
                        return;
                    }
                }
                
                // „Ç≥„Éî„Éº„Éú„Çø„É≥„ÇívConsoleÂÜÖ„Å´ËøΩÂä†
                if (!document.querySelector('.vc-copy-logs-btn')) {
                    const copyButton = document.createElement('button');
                    copyButton.className = 'vc-copy-logs-btn';
                    copyButton.innerHTML = 'üìã Copy All Logs';
                    copyButton.style.cssText = `
                        position: fixed;
                        top: 60px;
                        right: 15px;
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        cursor: pointer;
                        z-index: 99999;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    `;
                    
                    copyButton.addEventListener('click', () => {
                        copyAllLogs();
                    });
                    
                    // vConsoleË¶ÅÁ¥†„Åæ„Åü„ÅØbody„Å´ËøΩÂä†
                    const vconsoleRoot = document.querySelector('#__vconsole') || document.body;
                    vconsoleRoot.appendChild(copyButton);
                    console.log('‚úÖ Log copy button added to vConsole');
                }
                
                // ÂêÑ„É≠„Ç∞„Ç®„É≥„Éà„É™„Å´„ÇÇ„Ç≥„Éî„Éº„Éú„Çø„É≥„ÇíËøΩÂä†„Åô„ÇãÈñ¢Êï∞
                function addCopyButtonsToLogs() {
                    const logList = document.querySelector('#__vconsole .vc-log-list');
                    if (logList) {
                        // „É≠„Ç∞„É™„Çπ„Éà„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
                        const observer = new MutationObserver(() => {
                            const logItems = logList.querySelectorAll('.vc-item:not(.vc-copy-added)');
                            logItems.forEach(item => {
                                if (!item.querySelector('.vc-copy-single-btn')) {
                                    const copyBtn = document.createElement('span');
                                    copyBtn.className = 'vc-copy-single-btn';
                                    copyBtn.innerHTML = 'üìã';
                                    copyBtn.style.cssText = `
                                        display: inline-block;
                                        margin-left: 8px;
                                        cursor: pointer;
                                        opacity: 0.6;
                                        font-size: 12px;
                                    `;
                                    copyBtn.title = 'Copy this log';
                                    
                                    copyBtn.addEventListener('click', (e) => {
                                        e.stopPropagation();
                                        const logContent = item.textContent.replace('üìã', '').trim();
                                        copyToClipboard(logContent);
                                        showCopyFeedback(copyBtn);
                                    });
                                    
                                    const logContent = item.querySelector('.vc-item-content');
                                    if (logContent) {
                                        logContent.appendChild(copyBtn);
                                    }
                                    item.classList.add('vc-copy-added');
                                }
                            });
                        });
                        observer.observe(logList, { childList: true, subtree: true });
                    }
                }
                
                // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„É≠„Ç∞„Éú„Çø„É≥„ÇÇËøΩÂä†
                setTimeout(addCopyButtonsToLogs, 500);
                
            } catch (error) {
                console.error('‚ùå Failed to add log copy feature:', error);
            }
        }
        
        // „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„Ç≥„Éî„Éº„Éú„Çø„É≥„ÇíËøΩÂä†Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
        function addFloatingCopyButton() {
            if (document.querySelector('.vc-floating-copy-btn')) return;
            
            const floatingButton = document.createElement('button');
            floatingButton.className = 'vc-floating-copy-btn';
            floatingButton.innerHTML = 'üìã';
            floatingButton.title = 'Copy all vConsole logs';
            floatingButton.style.cssText = `
                position: fixed;
                bottom: 80px;
                right: 20px;
                width: 50px;
                height: 50px;
                background: #4CAF50;
                color: white;
                border: none;
                border-radius: 50%;
                font-size: 20px;
                cursor: pointer;
                z-index: 99999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            floatingButton.addEventListener('click', () => {
                copyAllLogs();
            });
            
            document.body.appendChild(floatingButton);
            console.log('‚úÖ Floating copy button added as fallback');
        }
        
        // ÂÖ®„É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åô„ÇãÈñ¢Êï∞
        function copyAllLogs() {
            try {
                // Ë§áÊï∞„ÅÆ„Çª„É¨„ÇØ„Çø„Éº„Åß„É≠„Ç∞„É™„Çπ„Éà„ÇíÊ§úÁ¥¢
                let logList = null;
                let logItems = [];
                
                const logSelectors = [
                    '#__vconsole .vc-log-list',
                    '#__vconsole .vc-content',
                    '#__vconsole [class*="log"]',
                    '#__vconsole .vc-panel',
                    '#__vconsole .vc-tabpanel'
                ];
                
                for (const selector of logSelectors) {
                    logList = document.querySelector(selector);
                    if (logList) {
                        // „É≠„Ç∞„Ç¢„Ç§„ÉÜ„É†„ÇíÊ§úÁ¥¢
                        const itemSelectors = ['.vc-item', '.vc-log-item', '[class*="item"]', 'div', 'p'];
                        for (const itemSelector of itemSelectors) {
                            logItems = logList.querySelectorAll(itemSelector);
                            if (logItems.length > 0) {
                                console.log(`‚úÖ Found ${logItems.length} log items with selector: ${selector} > ${itemSelector}`);
                                break;
                            }
                        }
                        if (logItems.length > 0) break;
                    }
                }
                
                if (!logList || logItems.length === 0) {
                    // vConsoleÂÖ®‰Ωì„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫
                    const vconsoleElement = document.querySelector('#__vconsole');
                    if (vconsoleElement) {
                        const allText = vconsoleElement.innerText || vconsoleElement.textContent;
                        if (allText) {
                            copyToClipboard(`=== PixelCanvas vConsole Content ===\n${allText}`);
                            alert('‚úÖ vConsole„ÅÆÂÖ®„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
                            return;
                        }
                    }
                    alert('‚ùå „É≠„Ç∞„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                let allLogs = [];
                
                logItems.forEach((item, index) => {
                    // „É≠„Ç∞„Çø„Ç§„Éó„ÇíË§áÊï∞„ÅÆÊñπÊ≥ï„ÅßÂà§ÂÆö
                    let logType = 'LOG';
                    const className = item.className || '';
                    const itemText = item.textContent || item.innerText || '';
                    
                    if (className.includes('error') || className.includes('vc-item-error') || 
                        itemText.includes('‚ùå') || itemText.includes('ERROR')) {
                        logType = 'ERROR';
                    } else if (className.includes('warn') || className.includes('vc-item-warn') || 
                              itemText.includes('‚ö†Ô∏è') || itemText.includes('WARN')) {
                        logType = 'WARN';
                    } else if (className.includes('info') || className.includes('vc-item-info') || 
                              itemText.includes('‚ÑπÔ∏è') || itemText.includes('INFO')) {
                        logType = 'INFO';
                    }
                    
                    // „ÉÜ„Ç≠„Çπ„ÉàÂÜÖÂÆπ„ÇíË§áÊï∞„ÅÆÊñπÊ≥ï„ÅßÊäΩÂá∫
                    let content = '';
                    
                    // 1. textContent„Åã„ÇâÂèñÂæó
                    if (item.textContent) {
                        content = item.textContent.replace('üìã', '').trim();
                    }
                    
                    // 2. Á©∫„ÅÆÂ†¥Âêà„ÅØÂ≠êË¶ÅÁ¥†„ÇíÊé¢„Åô
                    if (!content || content.length < 3) {
                        const contentElement = item.querySelector('.vc-item-content, .vc-content, .log-content');
                        if (contentElement) {
                            content = contentElement.textContent || contentElement.innerText || '';
                        }
                    }
                    
                    // 3. „Åæ„Å†Á©∫„ÅÆÂ†¥Âêà„ÅØÂÖ®„Å¶„ÅÆÂ≠êË¶ÅÁ¥†„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÁµêÂêà
                    if (!content || content.length < 3) {
                        const allTextNodes = [];
                        const walker = document.createTreeWalker(
                            item,
                            NodeFilter.SHOW_TEXT,
                            null,
                            false
                        );
                        
                        let node;
                        while (node = walker.nextNode()) {
                            const text = node.textContent.trim();
                            if (text && text !== 'üìã') {
                                allTextNodes.push(text);
                            }
                        }
                        content = allTextNodes.join(' ');
                    }
                    
                    // 4. ÊúÄÂæå„ÅÆÊâãÊÆµ: innerHTML „Åã„ÇâÊäΩÂá∫
                    if (!content || content.length < 3) {
                        content = item.innerHTML.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    }
                    
                    // Á©∫„ÅÆÂ†¥Âêà„ÅØDOMÊÉÖÂ†±„ÇíÂê´„ÇÅ„Çã
                    if (!content || content.length < 3) {
                        content = `[Empty log item - className: ${className}, tagName: ${item.tagName}]`;
                    }
                    
                    // „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÇíÊäΩÂá∫Ë©¶Ë°å
                    const timeElement = item.querySelector('.vc-item-time, .timestamp, [class*="time"]');
                    const timestamp = timeElement ? timeElement.textContent : new Date().toLocaleTimeString();
                    
                    allLogs.push(`[${index + 1}] [${timestamp}] [${logType}] ${content}`);
                });
                
                // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇÇÂê´„ÇÅ„Çã
                const debugInfo = [
                    `Debug Info:`,
                    `- Log List Selector: ${logSelectors.find(s => document.querySelector(s)) || 'Not found'}`,
                    `- Log Items Found: ${logItems.length}`,
                    `- Sample Item HTML: ${logItems[0] ? logItems[0].outerHTML.substring(0, 200) + '...' : 'None'}`,
                    `- vConsole DOM: ${document.querySelector('#__vconsole') ? 'Found' : 'Not found'}`,
                    ''
                ];
                
                const logText = [
                    '=== PixelCanvas vConsole Logs ===',
                    `Exported: ${new Date().toLocaleString()}`,
                    `Total Logs: ${allLogs.length}`,
                    '=' .repeat(40),
                    '',
                    ...debugInfo,
                    ...allLogs,
                    '',
                    '=== End of Logs ==='
                ].join('\n');
                
                copyToClipboard(logText);
                
                // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
                const button = document.querySelector('.vc-copy-logs-btn');
                if (button) {
                    const originalText = button.innerHTML;
                    button.innerHTML = '‚úÖ Copied!';
                    button.style.background = '#2196F3';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.background = '#4CAF50';
                    }, 1500);
                }
                
                console.log(`üìã ${allLogs.length} logs copied to clipboard`);
                
            } catch (error) {
                console.error('‚ùå Failed to copy logs:', error);
                alert('‚ùå „É≠„Ç∞„ÅÆ„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }
        
        // „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åô„ÇãÈñ¢Êï∞
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                // Áèæ‰ª£ÁöÑ„Å™„Éñ„É©„Ç¶„Ç∂
                navigator.clipboard.writeText(text).catch(err => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                fallbackCopyTextToClipboard(text);
            }
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                console.log('üìã Copied using fallback method');
            } catch (err) {
                console.error('‚ùå Fallback copy failed:', err);
            }
            
            document.body.removeChild(textArea);
        }
        
        // „Ç≥„Éî„Éº„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
        function showCopyFeedback(element) {
            const original = element.innerHTML;
            element.innerHTML = '‚úÖ';
            element.style.color = '#4CAF50';
            setTimeout(() => {
                element.innerHTML = original;
                element.style.color = '';
            }, 1000);
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÖ¨Èñã
        window.copyAllVConsoleLogs = copyAllLogs;
        
    </script>
    
    <script src="idb.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="main.js" defer></script>
</body>
</html>