<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="PixelCanvas - ÂÖ±Âêå„Éî„ÇØ„Çª„É´„Ç¢„Éº„Éà„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†">
    <title>PixelCanvas - ÂÖ±Âêå„Éî„ÇØ„Çª„É´„Ç¢„Éº„Éà (Auto Deploy)</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.webmanifest">
    
    <link rel="preconnect" href="https://lgvjdefkyeuvquzckkvb.supabase.co">
    <link rel="dns-prefetch" href="https://lgvjdefkyeuvquzckkvb.supabase.co">
    
    <!-- PixiJS Libraries for Performance Enhancement - LOCAL INSTALL -->
    <!-- Core PixiJS v7.3.2 (LOCAL) -->
    <script src="pixi.min.js"></script>
    
    <!-- Module system polyfill for CommonJS libraries -->
    <script>
        // Setup module system for CommonJS libraries
        window.exports = {};
        window.module = { exports: window.exports };
        
        // Setup require function for CommonJS dependencies
        window.require = function(name) {
            if (name === '@pixi/display' || name === '@pixi/core' || name === '@pixi/constants' || name === '@pixi/math' || name === '@pixi/utils') {
                return window.PIXI;
            }
            return window.PIXI;
        };
    </script>
    
    <!-- PixiJS Tilemap Plugin v3.2.2 (LOCAL) -->
    <script src="pixi-tilemap.js"></script>
    
    <!-- PixiJS Viewport Plugin v5.0.2 (LOCAL) -->
    <script src="pixi-viewport.js"></script>
    
    <!-- Setup PIXI namespace (LOCAL VERSION) -->
    <script>
        // Setup plugin namespaces after all scripts load
        window.addEventListener('load', () => {
            console.log('üîß Setting up PIXI plugins from local files...');
            
            // Debug what's available
            console.log('Available globals:', {
                exports: !!window.exports,
                module: !!window.module, 
                pixi_viewport: !!window.pixi_viewport,
                PIXI: !!window.PIXI
            });
            
            // Setup tilemap plugin from exports
            if (window.exports && window.PIXI) {
                window.PIXI.tilemap = window.exports;
                console.log('‚úÖ PIXI.tilemap attached from exports');
            }
            
            // Setup viewport plugin from pixi_viewport global
            if (window.pixi_viewport && window.pixi_viewport.Viewport && window.PIXI) {
                window.PIXI.Viewport = window.pixi_viewport.Viewport;
                console.log('‚úÖ PIXI.Viewport attached from pixi_viewport');
            }
            
            // Final verification
            console.log('Final plugin state:', {
                'PIXI.tilemap': !!(window.PIXI && window.PIXI.tilemap),
                'PIXI.Viewport': !!(window.PIXI && window.PIXI.Viewport),
                'tilemap.Tilemap': !!(window.PIXI && window.PIXI.tilemap && window.PIXI.tilemap.Tilemap)
            });
        });
    </script>
    
</head>
<body>
    <header class="header">
        <h1 class="header__title">PixelCanvas</h1>
        <div class="header__controls">
            <button class="grid-toggle" id="gridToggle" aria-label="Toggle Grid">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M2 2h6v6H2V2zm10 0h6v6h-6V2zM2 12h6v6H2v-6zm10 0h6v6h-6v-6z" stroke="currentColor" stroke-width="1"/>
                </svg>
            </button>
            <div class="pixel-count" id="pixelCount">0px</div>
            <div class="cooldown-indicator" id="cooldownIndicator"></div>
            <span class="status-indicator" id="status"></span>
        </div>
    </header>

    <main class="main">
        <div class="canvas-container" id="canvasContainer">
            <canvas id="mainCanvas" class="canvas"></canvas>
            <div class="canvas-overlay" id="canvasOverlay"></div>
        </div>
    </main>

    <footer class="controls">
        <div class="color-palette" id="colorPalette">
            <button class="color-button" data-color="0" style="background-color: #000000" aria-label="Black"></button>
            <button class="color-button" data-color="1" style="background-color: #FFFFFF" aria-label="White"></button>
            <button class="color-button" data-color="2" style="background-color: #FF0000" aria-label="Red"></button>
            <button class="color-button" data-color="3" style="background-color: #00FF00" aria-label="Green"></button>
            <button class="color-button" data-color="4" style="background-color: #0000FF" aria-label="Blue"></button>
            <button class="color-button" data-color="5" style="background-color: #FFFF00" aria-label="Yellow"></button>
            <button class="color-button" data-color="6" style="background-color: #FF00FF" aria-label="Magenta"></button>
            <button class="color-button" data-color="7" style="background-color: #00FFFF" aria-label="Cyan"></button>
            <button class="color-button" data-color="8" style="background-color: #800000" aria-label="Dark Red"></button>
            <button class="color-button" data-color="9" style="background-color: #008000" aria-label="Dark Green"></button>
            <button class="color-button" data-color="10" style="background-color: #000080" aria-label="Dark Blue"></button>
            <button class="color-button" data-color="11" style="background-color: #808000" aria-label="Olive"></button>
            <button class="color-button" data-color="12" style="background-color: #800080" aria-label="Purple"></button>
            <button class="color-button" data-color="13" style="background-color: #008080" aria-label="Teal"></button>
            <button class="color-button" data-color="14" style="background-color: #C0C0C0" aria-label="Silver"></button>
            <button class="color-button" data-color="15" style="background-color: #808080" aria-label="Gray"></button>
        </div>
    </footer>

    <!-- vConsole for mobile debugging -->
    <!-- ÂÆâÂÆöÁâà„Çí‰ΩøÁî®„Åô„ÇãÂ†¥Âêà„ÅØ‰ª•‰∏ã„Çí„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà -->
    <!-- <script src="https://unpkg.com/vconsole@3.15.1/dist/vconsole.min.js"></script> -->
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // Initialize vConsole for debugging
        try {
            const isMobile = window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Enable for mobile OR when URL contains debug=vconsole
            const forceVConsole = new URLSearchParams(window.location.search).get('debug') === 'vconsole';
            
            if (isMobile || forceVConsole) {
                const vc = new VConsole({ 
                    maxLogNumber: 2000,
                    theme: 'dark'
                });
                
                // ‚ñº„Ç™„Éó„Ç∑„Éß„É≥„É°„Éã„É•„Éº„Å´„ÄåCopy Logs„Äç„ÇíËøΩÂä†
                vc.addOptionMenu({
                    name: 'Copy Logs',
                    onClick() {
                        // Log „Éó„É©„Ç∞„Ç§„É≥„ÅÆÂÜÖÈÉ®ÈÖçÂàó„ÇíÂèñÂæó
                        const logs = vc.pluginList.log.data;
                        const text = logs
                            .map(item => item.log.join(' '))  // ÈÖçÂàó„Çí 1 Ë°åÊñáÂ≠óÂàó„Å´
                            .join('\n');

                        navigator.clipboard.writeText(text).then(() => {
                            alert('üìã ÂÖ®„É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
                        }).catch(() => {
                            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Çí‰ΩøÁî®
                            const textarea = document.createElement('textarea');
                            textarea.value = text;
                            document.body.appendChild(textarea);
                            textarea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textarea);
                            alert('üìã ÂÖ®„É≠„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
                        });
                    },
                });
                
                console.log('üì± vConsole ready for debugging!');
                console.log(`üì¶ vConsole version: ${vc.version || 'unknown'}`);
                console.warn('‚ö†Ô∏è Warning test message');
                console.error('‚ùå Error test message');
                
                console.log(`üì± vConsole initialized - Mobile: ${isMobile}, Forced: ${forceVConsole}`);
                
                // Store reference globally for testing
                window.vc = vc;
            } else {
                console.log('üíª Desktop mode - vConsole disabled (add ?debug=vconsole to URL to force enable)');
            }
        } catch (error) {
            console.error('‚ùå Failed to initialize vConsole:', error);
        }
    </script>

    <script src="idb.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="main.js" defer></script>
</body>
</html>
